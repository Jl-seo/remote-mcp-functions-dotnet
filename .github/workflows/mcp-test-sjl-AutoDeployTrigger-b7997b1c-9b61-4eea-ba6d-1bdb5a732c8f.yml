name: Trigger auto deployment for mcp-test-sjl

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build â†’ Push â†’ Deploy to Container Apps
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜‘ï¸  Checkout source
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Azure login (OIDC, Service Principal)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Build, push, and deploy Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          # â”€â”€ Azure target â”€â”€
          resourceGroup:    Dalle2               # ë¦¬ì†ŒìŠ¤ ê·¸ë£¹
          containerAppName: mcp-test-sjl         # ì»¨í…Œì´ë„ˆ ì•± ì´ë¦„
          targetPort:       80                   # Ingress TargetPort
          ingress:          external

          # â”€â”€ ì†ŒìŠ¤ â†’ ì´ë¯¸ì§€ ë¹Œë“œ & ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ â”€â”€
          appSourcePath:    ${{ github.workspace }}
          dockerfilePath:   ./Dockerfile
          imageToBuild:     mcpregistry.azurecr.io/mcp-test-sjl:${{ github.sha }}
          registryUrl:      mcpregistry.azurecr.io
          registryUsername: ${{ secrets.MCPTESTSJL_REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.MCPTESTSJL_REGISTRY_PASSWORD }}

          # (ì„ íƒ) ë¹Œë“œ ARG
          buildArguments: |
            FOO=bar
            BAR=baz

          # â”€â”€ ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ â”€â”€
          environmentVariables: |
            client-id=${{ secrets.CLIENT_ID }}
            client-secret=${{ secrets.CLIENT_SECRET }}
            tenant-id=${{ secrets.TENANT_ID }}
